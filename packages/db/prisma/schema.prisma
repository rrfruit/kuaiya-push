// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output = "../generated/client"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum PlatformStatus {
  ACTIVE
  INACTIVE
}

enum AccountStatus {
  NOT_LOGGED_IN
  LOGGED_IN
  LOGIN_EXPIRED
}

enum WorkStatus {
  DRAFT
  SCHEDULED
  PUBLISHING
  PUBLISHED
  FAILED
}

enum PublishStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  SUCCESS
  FAILED
  CANCELLED
}

enum ProxyType {
  HTTP
  HTTPS
  SOCKS5
}

enum ProxyStatus {
  AVAILABLE
  UNAVAILABLE
  EXPIRED
}

enum WorkType {
  TEXT
  IMAGE
  VIDEO
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  role      String?  @default("user")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts       Account[]
  works          Work[]
  proxies        Proxy[]
  publishRecords WorkPublishRecord[]
}

model Platform {
  id          String         @id @default(cuid())
  name        String
  code        String         @unique
  description String?
  apiBaseUrl  String?
  status      PlatformStatus @default(ACTIVE)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  accounts       Account[]
  publishRecords WorkPublishRecord[]
}

model Account {
  id             String        @id @default(cuid())
  userId         String
  platformId     String
  proxyId        String?
  displayName    String
  coverUrl       String?
  platformUserId String?
  status         AccountStatus @default(NOT_LOGGED_IN)
  lastSyncedAt   DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  user     User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  platform Platform            @relation(fields: [platformId], references: [id], onDelete: Cascade)
  proxy    Proxy?              @relation(fields: [proxyId], references: [id], onDelete: SetNull)
  records  WorkPublishRecord[]

  @@unique([platformId, platformUserId])
}

model Work {
  id          String     @id @default(cuid())
  userId      String
  title       String
  type        WorkType @default(TEXT)
  description String
  mediaUrl    String
  coverUrl    String?
  content     String?
  imgs        String?
  status      WorkStatus @default(DRAFT)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  user    User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  records WorkPublishRecord[]
}

model WorkPublishRecord {
  id           String        @id @default(cuid())
  userId       String
  workId       String
  accountId    String
  platformId   String
  status       PublishStatus @default(PENDING)
  scheduledAt  DateTime?
  startedAt    DateTime?
  publishedAt  DateTime?
  retryCount   Int           @default(0)
  responseData Json?
  errorMessage String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  work     Work     @relation(fields: [workId], references: [id], onDelete: Cascade)
  account  Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  platform Platform @relation(fields: [platformId], references: [id], onDelete: Cascade)

  @@unique([workId, accountId])
  @@index([platformId])
  @@index([status])
}

model Proxy {
  id         String      @id @default(cuid())
  userId     String
  name       String?
  type       ProxyType   @default(HTTP)
  host       String
  port       Int
  username   String?
  password   String?
  status     ProxyStatus @default(AVAILABLE)
  location   String?
  lastUsedAt DateTime?
  expireAt   DateTime?
  remark     String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accounts Account[]
}
